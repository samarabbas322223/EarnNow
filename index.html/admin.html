<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - EarnNow</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1E3A8A;
            --accent: #FACC15;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary);
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-accent {
            background-color: var(--accent);
            color: var(--dark);
            border-color: var(--accent);
        }
        
        .admin-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .admin-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .badge-pending {
            background-color: #ffc107;
            color: #212529;
        }
        
        .badge-approved {
            background-color: #198754;
        }
        
        .badge-rejected {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-coins me-2"></i>EarnNow
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="admin.html">Admin</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Admin Content -->
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="fw-bold">Admin Panel</h1>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" id="refreshBtn">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
        
        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalUsers">0</div>
                    <p class="text-muted mb-0">Total Users</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalPayouts">$0</div>
                    <p class="text-muted mb-0">Total Payouts</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="pendingRequests">0</div>
                    <p class="text-muted mb-0">Pending Requests</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="activeToday">0</div>
                    <p class="text-muted mb-0">Active Today</p>
                </div>
            </div>
        </div>
        
        <!-- Withdrawal Requests -->
        <div class="admin-card">
            <h3 class="fw-bold mb-4">Withdrawal Requests</h3>
            
            <div class="table-responsive">
                <table class="table table-hover admin-table">
                    <thead class="table-light">
                        <tr>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTable">
                        <!-- Requests will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- User Management -->
        <div class="admin-card">
            <h3 class="fw-bold mb-4">User Management</h3>
            
            <div class="table-responsive">
                <table class="table table-hover admin-table">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Balance</th>
                            <th>Total Earnings</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <!-- Users will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <!-- Admin Logic -->
    <script>
        let currentUser = null;
        let unsubscribeRequests = null;
        let unsubscribeUsers = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication state and admin role
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    checkAdminRole(user.uid);
                } else {
                    // User is not logged in, redirect to login
                    window.location.href = 'login.html';
                }
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (unsubscribeRequests) unsubscribeRequests();
                if (unsubscribeUsers) unsubscribeUsers();
                
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });
            
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', function() {
                loadStats();
            });
        });
        
        // Check if user is admin
        function checkAdminRole(uid) {
            db.collection('users').doc(uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        
                        if (userData.role === 'admin') {
                            // User is admin, load admin data
                            loadStats();
                            setupRealTimeListeners();
                        } else {
                            // User is not admin, redirect to dashboard
                            showToast('Access denied. Admin privileges required.', 'warning');
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 2000);
                        }
                    } else {
                        showToast('User data not found', 'warning');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    }
                })
                .catch((error) => {
                    console.error('Error checking admin role:', error);
                    showToast('Error checking permissions', 'danger');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                });
        }
        
        // Load admin stats
        function loadStats() {
            // Total users
            db.collection('users').get()
                .then((querySnapshot) => {
                    document.getElementById('totalUsers').textContent = querySnapshot.size;
                    
                    // Calculate total payouts (from approved requests)
                    return db.collection('requests')
                        .where('status', '==', 'approved')
                        .get();
                })
                .then((querySnapshot) => {
                    let totalPayouts = 0;
                    querySnapshot.forEach((doc) => {
                        totalPayouts += doc.data().amount;
                    });
                    document.getElementById('totalPayouts').textContent = '$' + totalPayouts.toFixed(2);
                    
                    // Pending requests count
                    return db.collection('requests')
                        .where('status', '==', 'pending')
                        .get();
                })
                .then((querySnapshot) => {
                    document.getElementById('pendingRequests').textContent = querySnapshot.size;
                    
                    // Active today (dummy value for demo)
                    document.getElementById('activeToday').textContent = Math.floor(Math.random() * 100) + 50;
                })
                .catch((error) => {
                    console.error('Error loading stats:', error);
                });
        }
        
        // Setup real-time listeners for requests and users
        function setupRealTimeListeners() {
            // Real-time listener for withdrawal requests
            unsubscribeRequests = db.collection('requests')
                .orderBy('date', 'desc')
                .onSnapshot((querySnapshot) => {
                    const requestsTable = document.getElementById('requestsTable');
                    requestsTable.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        requestsTable.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No withdrawal requests</td></tr>';
                        return;
                    }
                    
                    // We'll need to get user data for each request
                    const promises = [];
                    
                    querySnapshot.forEach((doc) => {
                        const request = doc.data();
                        const requestId = doc.id;
                        
                        // Get user data for this request
                        const promise = db.collection('users').doc(request.userId).get()
                            .then((userDoc) => {
                                let userName = 'Unknown User';
                                let userEmail = 'N/A';
                                
                                if (userDoc.exists) {
                                    const userData = userDoc.data();
                                    userName = userData.name;
                                    userEmail = userData.email;
                                }
                                
                                const date = request.date ? request.date.toDate().toLocaleDateString() : 'N/A';
                                
                                let statusBadge = '';
                                if (request.status === 'approved') {
                                    statusBadge = '<span class="badge badge-approved">Approved</span>';
                                } else if (request.status === 'rejected') {
                                    statusBadge = '<span class="badge badge-rejected">Rejected</span>';
                                } else {
                                    statusBadge = '<span class="badge badge-pending">Pending</span>';
                                }
                                
                                let actionButtons = '';
                                if (request.status === 'pending') {
                                    actionButtons = `
                                        <button class="btn btn-sm btn-success me-1" onclick="approveRequest('${requestId}')">
                                            <i class="fas fa-check me-1"></i>Approve
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="rejectRequest('${requestId}')">
                                            <i class="fas fa-times me-1"></i>Reject
                                        </button>
                                    `;
                                } else {
                                    actionButtons = '<span class="text-muted">Completed</span>';
                                }
                                
                                const row = `
                                    <tr>
                                        <td>
                                            <div>${userName}</div>
                                            <small class="text-muted">${userEmail}</small>
                                        </td>
                                        <td>$${request.amount.toFixed(2)}</td>
                                        <td>${request.method}</td>
                                        <td>${date}</td>
                                        <td>${statusBadge}</td>
                                        <td>${actionButtons}</td>
                                    </tr>
                                `;
                                
                                return row;
                            });
                        
                        promises.push(promise);
                    });
                    
                    // Wait for all user data to be fetched
                    Promise.all(promises)
                        .then((rows) => {
                            requestsTable.innerHTML = rows.join('');
                        })
                        .catch((error) => {
                            console.error('Error loading requests:', error);
                        });
                }, (error) => {
                    console.error('Error setting up requests listener:', error);
                });
            
            // Real-time listener for users
            unsubscribeUsers = db.collection('users')
                .onSnapshot((querySnapshot) => {
                    const usersTable = document.getElementById('usersTable');
                    usersTable.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        usersTable.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No users found</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const user = doc.data();
                        const userId = doc.id;
                        
                        let roleBadge = '';
                        if (user.role === 'admin') {
                            roleBadge = '<span class="badge bg-primary">Admin</span>';
                        } else {
                            roleBadge = '<span class="badge bg-secondary">User</span>';
                        }
                        
                        const row = `
                            <tr>
                                <td>${user.name}</td>
                                <td>${user.email}</td>
                                <td>${roleBadge}</td>
                                <td>$${user.balance.toFixed(2)}</td>
                                <td>$${user.totalEarnings.toFixed(2)}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editUserModal" onclick="openEditUserModal('${userId}', '${user.name}', '${user.email}', '${user.role}', ${user.balance}, ${user.totalEarnings})">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </button>
                                </td>
                            </tr>
                        `;
                        
                        usersTable.innerHTML += row;
                    });
                }, (error) => {
                    console.error('Error setting up users listener:', error);
                });
        }
        
        // Approve withdrawal request
        function approveRequest(requestId) {
            db.collection('requests').doc(requestId).update({
                status: 'approved'
            })
            .then(() => {
                showToast('Withdrawal request approved', 'success');
            })
            .catch((error) => {
                console.error('Error approving request:', error);
                showToast('Error approving request', 'danger');
            });
        }
        
        // Reject withdrawal request
        function rejectRequest(requestId) {
            db.collection('requests').doc(requestId).update({
                status: 'rejected'
            })
            .then(() => {
                showToast('Withdrawal request rejected', 'success');
            })
            .catch((error) => {
                console.error('Error rejecting request:', error);
                showToast('Error rejecting request', 'danger');
            });
        }
        
        // Open edit user modal
        function openEditUserModal(userId, name, email, role, balance, totalEarnings) {
            // In a real implementation, you would populate a modal with this data
            // and provide forms to edit the user's information
            showToast(`Edit user: ${name} (${email}) - This would open a modal in a full implementation`, 'info');
            
            // Example of how you might implement this:
            // document.getElementById('editUserId').value = userId;
            // document.getElementById('editUserName').value = name;
            // document.getElementById('editUserEmail').value = email;
            // document.getElementById('editUserRole').value = role;
            // document.getElementById('editUserBalance').value = balance;
            // document.getElementById('editUserTotalEarnings').value = totalEarnings;
        }
        
        // Toast function
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove toast from DOM after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
    </script>
</body>
</html>