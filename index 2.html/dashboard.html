<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - EarnNow</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1E3A8A;
            --accent: #FACC15;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary);
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-accent {
            background-color: var(--accent);
            color: var(--dark);
            border-color: var(--accent);
        }
        
        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .balance-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin: 20px 0;
        }
        
        .action-btn {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            background: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0,0,0,0.1);
        }
        
        .action-icon {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .referral-link {
            background-color: #f8f9fa;
            border: 1px dashed #ced4da;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            word-break: break-all;
        }
        
        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .nav-pills .nav-link.active {
            background-color: var(--primary);
        }
        
        .nav-pills .nav-link {
            color: var(--dark);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-coins me-2"></i>EarnNow
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="container py-5">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
                <div class="sidebar">
                    <div class="text-center mb-4">
                        <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                            <i class="fas fa-user text-white" style="font-size: 2rem;"></i>
                        </div>
                        <h5 class="mt-3 mb-1" id="userName">Loading...</h5>
                        <p class="text-muted mb-0" id="userEmail">Loading...</p>
                    </div>
                    
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#overview" data-bs-toggle="tab">
                                <i class="fas fa-chart-line me-2"></i>Overview
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#earn" data-bs-toggle="tab">
                                <i class="fas fa-money-bill-wave me-2"></i>Earn Money
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#withdraw" data-bs-toggle="tab">
                                <i class="fas fa-wallet me-2"></i>Withdraw
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#referrals" data-bs-toggle="tab">
                                <i class="fas fa-users me-2"></i>Refer & Earn
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="tab-content">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview">
                        <div class="dashboard-card">
                            <h3 class="fw-bold mb-4">Account Overview</h3>
                            
                            <div class="row text-center">
                                <div class="col-md-4 mb-4">
                                    <div class="balance-display" id="currentBalance">$0.00</div>
                                    <p class="text-muted">Current Balance</p>
                                </div>
                                <div class="col-md-4 mb-4">
                                    <div class="balance-display text-success" id="totalEarnings">$0.00</div>
                                    <p class="text-muted">Total Earnings</p>
                                </div>
                                <div class="col-md-4 mb-4">
                                    <div class="balance-display text-primary" id="referralCount">0</div>
                                    <p class="text-muted">Referrals</p>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <h5>Recent Activity</h5>
                                    <div class="list-group">
                                        <div class="list-group-item border-0">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">Daily Bonus</h6>
                                                <small class="text-success">+$0.50</small>
                                            </div>
                                            <small class="text-muted">Today</small>
                                        </div>
                                        <div class="list-group-item border-0">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">Watched Ad</h6>
                                                <small class="text-success">+$0.10</small>
                                            </div>
                                            <small class="text-muted">Yesterday</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5>Quick Actions</h5>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="switchTab('earn')">
                                            <i class="fas fa-money-bill-wave me-2"></i>Earn Money
                                        </button>
                                        <button class="btn btn-accent" onclick="switchTab('withdraw')">
                                            <i class="fas fa-wallet me-2"></i>Withdraw Funds
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Earn Money Tab -->
                    <div class="tab-pane fade" id="earn">
                        <div class="dashboard-card">
                            <h3 class="fw-bold mb-4">Earn Money</h3>
                            <p class="text-muted mb-4">Complete these tasks to earn money instantly</p>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="action-btn" id="watchAdBtn">
                                        <div class="action-icon">
                                            <i class="fas fa-play-circle"></i>
                                        </div>
                                        <h5>Watch Ads</h5>
                                        <p class="text-muted mb-2">Earn $0.10 per ad</p>
                                        <small class="text-success">Available Now</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="action-btn" id="dailyBonusBtn">
                                        <div class="action-icon">
                                            <i class="fas fa-gift"></i>
                                        </div>
                                        <h5>Daily Bonus</h5>
                                        <p class="text-muted mb-2">Claim $0.50 daily</p>
                                        <small class="text-success" id="dailyBonusStatus">Available</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="action-btn" onclick="switchTab('referrals')">
                                        <div class="action-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <h5>Refer Friends</h5>
                                        <p class="text-muted mb-2">Earn $1 per referral</p>
                                        <small class="text-success">Unlimited</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Withdraw Tab -->
                    <div class="tab-pane fade" id="withdraw">
                        <div class="dashboard-card">
                            <h3 class="fw-bold mb-4">Withdraw Funds</h3>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <h5>Withdrawal Methods</h5>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="withdrawMethod" id="paypal" value="paypal" checked>
                                            <label class="form-check-label" for="paypal">
                                                <i class="fab fa-paypal me-2"></i>PayPal
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="withdrawMethod" id="bank" value="bank">
                                            <label class="form-check-label" for="bank">
                                                <i class="fas fa-university me-2"></i>Bank Transfer
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="withdrawMethod" id="giftcard" value="giftcard">
                                            <label class="form-check-label" for="giftcard">
                                                <i class="fas fa-credit-card me-2"></i>Gift Card
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <form id="withdrawForm">
                                        <div class="mb-3">
                                            <label for="withdrawAmount" class="form-label">Amount to Withdraw</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="withdrawAmount" min="5" step="0.01" required>
                                            </div>
                                            <div class="form-text">Minimum withdrawal: $5.00</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="withdrawEmail" class="form-label">PayPal Email</label>
                                            <input type="email" class="form-control" id="withdrawEmail" required>
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary">Request Withdrawal</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="mt-5">
                                <h5>Withdrawal History</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Amount</th>
                                                <th>Method</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="withdrawalHistory">
                                            <!-- Withdrawal history will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Referrals Tab -->
                    <div class="tab-pane fade" id="referrals">
                        <div class="dashboard-card">
                            <h3 class="fw-bold mb-4">Refer & Earn</h3>
                            <p class="text-muted mb-4">Earn $1 for every friend who signs up using your referral link</p>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label class="form-label">Your Referral Link</label>
                                        <div class="referral-link mb-2" id="referralLink">Loading...</div>
                                        <button class="btn btn-sm btn-outline-primary" id="copyReferralBtn">
                                            <i class="fas fa-copy me-1"></i>Copy Link
                                        </button>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h5>How It Works</h5>
                                        <ul class="list-unstyled">
                                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Share your unique referral link</li>
                                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Your friend signs up and verifies their account</li>
                                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>You receive $1 when they earn their first $5</li>
                                            <li><i class="fas fa-check text-success me-2"></i>No limit on how many friends you can refer</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="bg-light p-4 rounded-3">
                                        <h5>Your Referrals</h5>
                                        <div class="text-center py-4" id="referralsList">
                                            <p class="text-muted">No referrals yet. Share your link to start earning!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <!-- Dashboard Logic -->
    <script>
        let currentUser = null;
        let userData = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication state
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                    setupEarningActions(user.uid);
                    loadWithdrawalHistory(user.uid);
                    setupReferralSystem(user.uid);
                } else {
                    // User is not logged in, redirect to login
                    window.location.href = 'login.html';
                }
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });
            
            // Withdraw form submission
            document.getElementById('withdrawForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const amount = parseFloat(document.getElementById('withdrawAmount').value);
                const method = document.querySelector('input[name="withdrawMethod"]:checked').value;
                const email = document.getElementById('withdrawEmail').value;
                
                // Validate amount
                if (amount < 5) {
                    showToast('Minimum withdrawal amount is $5', 'warning');
                    return;
                }
                
                if (amount > userData.balance) {
                    showToast('Insufficient balance', 'warning');
                    return;
                }
                
                // Create withdrawal request
                db.collection('requests').add({
                    userId: currentUser.uid,
                    amount: amount,
                    method: method,
                    email: email,
                    status: 'pending',
                    date: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    showToast('Withdrawal request submitted successfully', 'success');
                    document.getElementById('withdrawForm').reset();
                    
                    // Update user balance (in a real app, this would be done server-side)
                    const newBalance = userData.balance - amount;
                    db.collection('users').doc(currentUser.uid).update({
                        balance: newBalance
                    });
                })
                .catch((error) => {
                    console.error('Error submitting withdrawal request:', error);
                    showToast('Error submitting withdrawal request', 'danger');
                });
            });
        });
        
        // Load user data from Firestore
        function loadUserData(uid) {
            db.collection('users').doc(uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        userData = doc.data();
                        
                        // Update UI with user data
                        document.getElementById('userName').textContent = userData.name;
                        document.getElementById('userEmail').textContent = userData.email;
                        document.getElementById('currentBalance').textContent = '$' + userData.balance.toFixed(2);
                        document.getElementById('totalEarnings').textContent = '$' + userData.totalEarnings.toFixed(2);
                        
                        // Set withdrawal email to user's email by default
                        document.getElementById('withdrawEmail').value = userData.email;
                    } else {
                        showToast('User data not found', 'warning');
                    }
                })
                .catch((error) => {
                    console.error('Error getting user document:', error);
                    showToast('Error loading user data', 'danger');
                });
        }
        
        // Setup earning action buttons
        function setupEarningActions(uid) {
            // Watch Ad button
            document.getElementById('watchAdBtn').addEventListener('click', function() {
                const earnings = 0.10;
                
                // Update user balance
                const newBalance = userData.balance + earnings;
                const newTotalEarnings = userData.totalEarnings + earnings;
                
                db.collection('users').doc(uid).update({
                    balance: newBalance,
                    totalEarnings: newTotalEarnings
                })
                .then(() => {
                    showToast(`You earned $${earnings.toFixed(2)} from watching an ad!`, 'success');
                    userData.balance = newBalance;
                    userData.totalEarnings = newTotalEarnings;
                    document.getElementById('currentBalance').textContent = '$' + newBalance.toFixed(2);
                    document.getElementById('totalEarnings').textContent = '$' + newTotalEarnings.toFixed(2);
                })
                .catch((error) => {
                    console.error('Error updating balance:', error);
                    showToast('Error updating balance', 'danger');
                });
            });
            
            // Daily Bonus button
            document.getElementById('dailyBonusBtn').addEventListener('click', function() {
                const earnings = 0.50;
                
                // Update user balance
                const newBalance = userData.balance + earnings;
                const newTotalEarnings = userData.totalEarnings + earnings;
                
                db.collection('users').doc(uid).update({
                    balance: newBalance,
                    totalEarnings: newTotalEarnings
                })
                .then(() => {
                    showToast(`You claimed your daily bonus of $${earnings.toFixed(2)}!`, 'success');
                    userData.balance = newBalance;
                    userData.totalEarnings = newTotalEarnings;
                    document.getElementById('currentBalance').textContent = '$' + newBalance.toFixed(2);
                    document.getElementById('totalEarnings').textContent = '$' + newTotalEarnings.toFixed(2);
                    
                    // Disable daily bonus for today
                    document.getElementById('dailyBonusStatus').textContent = 'Claimed Today';
                    document.getElementById('dailyBonusStatus').className = 'text-muted';
                    document.getElementById('dailyBonusBtn').style.opacity = '0.7';
                    document.getElementById('dailyBonusBtn').style.cursor = 'not-allowed';
                })
                .catch((error) => {
                    console.error('Error updating balance:', error);
                    showToast('Error updating balance', 'danger');
                });
            });
        }
        
        // Load withdrawal history
        function loadWithdrawalHistory(uid) {
            db.collection('requests')
                .where('userId', '==', uid)
                .orderBy('date', 'desc')
                .limit(5)
                .get()
                .then((querySnapshot) => {
                    const historyTable = document.getElementById('withdrawalHistory');
                    historyTable.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        historyTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No withdrawal history</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const request = doc.data();
                        const date = request.date ? request.date.toDate().toLocaleDateString() : 'N/A';
                        
                        let statusBadge = '';
                        if (request.status === 'approved') {
                            statusBadge = '<span class="badge bg-success">Approved</span>';
                        } else if (request.status === 'rejected') {
                            statusBadge = '<span class="badge bg-danger">Rejected</span>';
                        } else {
                            statusBadge = '<span class="badge bg-warning">Pending</span>';
                        }
                        
                        const row = `
                            <tr>
                                <td>${date}</td>
                                <td>$${request.amount.toFixed(2)}</td>
                                <td>${request.method}</td>
                                <td>${statusBadge}</td>
                            </tr>
                        `;
                        
                        historyTable.innerHTML += row;
                    });
                })
                .catch((error) => {
                    console.error('Error loading withdrawal history:', error);
                });
        }
        
        // Setup referral system
        function setupReferralSystem(uid) {
            // Generate referral link
            const referralLink = `${window.location.origin}/login.html?ref=${uid}`;
            document.getElementById('referralLink').textContent = referralLink;
            
            // Copy referral link button
            document.getElementById('copyReferralBtn').addEventListener('click', function() {
                navigator.clipboard.writeText(referralLink)
                    .then(() => {
                        showToast('Referral link copied to clipboard!', 'success');
                    })
                    .catch(() => {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = referralLink;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showToast('Referral link copied to clipboard!', 'success');
                    });
            });
            
            // Load referrals count (in a real app, you would query the referrals collection)
            document.getElementById('referralCount').textContent = '0';
        }
        
        // Helper function to switch tabs
        function switchTab(tabId) {
            const tabTrigger = document.querySelector(`[href="#${tabId}"]`);
            const tab = new bootstrap.Tab(tabTrigger);
            tab.show();
        }
        
        // Toast function
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove toast from DOM after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
    </script>
</body>
</html>